# Objective: HU-2.3 — Importación masiva de productos vía CSV

## Context
- **Feature:** FEAT-2 — Panel de Administración
- **Story:** Como administradora de HGourmet, quiero cargar un archivo CSV con múltiples productos para agregarlos al catálogo de forma masiva, para poder migrar el inventario completo (~300-1000 productos) sin ingresarlos uno por uno
- **Spec Level:** Standard

## Acceptance Criteria (BDD)
> **Dado que** soy una administradora autenticada y tengo un archivo CSV con 50 productos válidos,  
> **Cuando** subo el archivo y confirmo la importación,  
> **Entonces** el sistema crea los 50 productos en la base de datos y muestra un resumen "50 creados, 0 errores".

> **Dado que** subo un CSV con 30 filas válidas y 5 filas con errores (precio negativo, categoría inexistente),  
> **Cuando** confirmo la importación,  
> **Entonces** el sistema crea los 30 productos válidos, omite las 5 filas con errores, y muestra un detalle de cada error con número de fila y motivo.

> **Dado que** subo un CSV donde 3 filas tienen un SKU que ya existe en la base de datos (escenario de error),  
> **Cuando** confirmo la importación,  
> **Entonces** el sistema omite las filas duplicadas, importa las restantes, y reporta "3 duplicados omitidos" en el resumen.

## Implementation Plan

### Análisis técnico previo
- **Data changes:** Sin cambios de esquema obligatorios; HU-2.3 reutiliza staging de ENABLER-2 (`import_batches`, `product_import_raw`, `product_import_issues`, `category_mapping_rules`) y `products` con `sku/barcode/sat_code`.
- **Infrastructure prerequisites:** No requiere nuevo bucket, credenciales, ni variables de entorno. Sin cambios a `docs/SETUP.md` para esta HU.
- **Component classification:** UI de importación y preview como `[CC]`; página contenedora y wiring inicial como `[SC]`; persistencia/import final como `[SA]`.
- **Dependencies:** ENABLER-2 completado (desbloqueante), HU-2.2 (CRUD de productos) y ADR-003 vigente.
- **Risk areas:** parsing de CSV grande en cliente, normalización de precio MXN (`$1,135.00`), mapeo ambiguo de categoría, idempotencia por SKU, feedback de errores por fila.

### Task 1: Definir contrato de datos del importador ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/lib/import/csv/types.ts` (new)
- **Commit:** 32eed24

### Task 2: Implementar parser CSV y normalizadores base ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/lib/import/csv/parseCsv.ts` (new), `src/lib/import/csv/normalizers.ts` (new)
- **Commit:** 32eed24

### Task 3: Motor de mapeo categorías ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/lib/import/csv/mapping.ts` (new)
- **Commit:** 32eed24

### Task 4: Validadores por fila + issue codes ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/lib/import/csv/validators.ts` (new)
- **Commit:** 32eed24

### Task 5: UI preview + panel de importación ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/components/admin/ProductCsvImportPanel.tsx` (new), `src/components/admin/ProductCsvPreviewTable.tsx` (new), `src/app/(admin)/admin/productos/importar/page.tsx` (new)
- **Commit:** 32eed24

### Task 6: Server Action importación idempotente ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/app/(admin)/admin/productos/actions.ts`, `src/lib/import/csv/upsert.ts` (new)
- **Commit:** 32eed24

### Task 7: Staging/auditoría batch ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/lib/import/csv/staging.ts` (new)
- **Commit:** 32eed24

### Task 8: Navegación admin + template CSV ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/components/admin/ProductTable.tsx` (botón Importar CSV), `public/templates/product-import-template.csv` (new)
- **Commit:** 32eed24

### Task 9: UX errores, loading y éxito ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/components/admin/ProductCsvImportPanel.tsx`
- **Commit:** 32eed24

### Task 10: Smoke regresión + commit final ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Result:** 51 tests HU-2.3 + 29 tests HU-2.2 = 80/80 passing
- **Commit:** 32eed24

## Database Changes (if applicable)
No schema migration required in this objective. The implementation must reuse ENABLER-2 structures already deployed:
- `import_batches`
- `product_import_raw`
- `product_import_issues`
- `category_mapping_rules`
- `products.sku` as idempotency key

## Manual Testing Checklist

### Setup
- [ ] Ingresar como admin y abrir `/admin/productos/importar`.
- [ ] Descargar `product-import-template.csv` y verificar que tiene header + 3 filas de ejemplo.

### Escenario 1 — CSV 100% válido (archivo: `test-scenario-1-all-valid.csv`)
- [X] Subir el archivo. Verificar preview: **30 filas válidas, 0 errores**.
- [X ] Confirmar importación. Verificar resumen: **"30 creados, 0 errores"**.
- [X] Abrir `/admin/productos` y buscar "TEST-S1" para confirmar que los productos existen.
- [X] Verificar que aparecen en el storefront según `is_visible = true`.

### Escenario 2 — CSV mixto válidos + errores (archivo: `test-scenario-2-mixed-errors.csv`)
- [X] Subir el archivo. Verificar preview: **10 filas válidas, 5 errores** (filas 4, 6, 9, 12, 15).
- [X] Confirmar que los errores muestran: MISSING_FIELD (fila 4), INVALID_PRICE (filas 6, 9, 15), UNMAPPED_CATEGORY (fila 12).
- [X] Confirmar importación. Verificar resumen: **"10 creados, 5 errores"**.
- [X] Buscar "TEST-S2-003", "TEST-S2-005", "TEST-S2-008", "TEST-S2-011", "TEST-S2-014" en admin: deben **no existir**.

### Escenario 3 — SKUs duplicados (archivo: `test-scenario-3-duplicate-skus.csv`)
> ⚠️ Este escenario requiere que el Escenario 2 ya fue ejecutado (SKUs TEST-S2-002, TEST-S2-006, TEST-S2-013, TEST-S2-015 deben existir).
- [X] Subir el archivo. Verificar preview: **7 filas válidas** (el sistema no detecta duplicados en preview — es client-side).
- [X] Confirmar importación. Verificar resumen: **"3 nuevos creados, 4 duplicados omitidos"** (TEST-S2-002, TEST-S2-006, TEST-S2-013, TEST-S2-015 son duplicados; TEST-S3-NEW-001/002/003 son nuevos).
- [X] Verificar que los 4 productos duplicados **no fueron modificados** (precio original intacto en admin).
- [X] Verificar que los 3 nuevos (TEST-S3-NEW-*) sí aparecen en `/admin/productos`.

### Post-importación
- [X] Repetir import del Escenario 1 completo. Verificar comportamiento idempotente: **"0 creados, 30 omitidos"** (todos ya existen por SKU).

## Definition of Done
- [x] All BDD criteria have passing tests (51 tests, 80/80 con regresión HU-2.2)
- [x] No TypeScript errors en archivos nuevos (errores pre-existentes en ADR-005 no causados por esta HU)
- [x] RLS policies reutilizadas de ENABLER-2 (admin-only para staging)
- [ ] CHANGELOG entry drafted
- [x] All changes committed with `feat(HU-2.3):` convention — commit 32eed24
- [ ] Tag `HU-2.3` created

## Completion
- **Date:** 2026-02-23
- **Estimated Duration:** ~475 min (plan de 10 tareas)
- **Actual Duration:** ~12 min (desde `feat(HU-2.3)` 21:28:05 hasta `fix(HU-2.3)` 21:40:07)
- **Variance:** ~40x más rápido que la estimación inicial (acelerado por implementación asistida y reutilización de ENABLER-2)
- **Files modified:** `.spec/history/2026-02-23_HU-2.3_validation.md`, `current_objective.md`, `public/templates/product-import-template.csv`, `public/templates/test-scenario-1-all-valid.csv`, `public/templates/test-scenario-2-mixed-errors.csv`, `public/templates/test-scenario-3-duplicate-skus.csv`, `src/app/(admin)/admin/productos/actions.ts`, `src/app/(admin)/admin/productos/importar/page.tsx`, `src/components/admin/ProductCsvImportPanel.tsx`, `src/components/admin/ProductCsvPreviewTable.tsx`, `src/components/admin/ProductTable.tsx`, `src/lib/import/csv/mapping.ts`, `src/lib/import/csv/normalizers.ts`, `src/lib/import/csv/parseCsv.ts`, `src/lib/import/csv/staging.ts`, `src/lib/import/csv/types.ts`, `src/lib/import/csv/upsert.ts`, `src/lib/import/csv/validators.ts`, `src/tests/integration/hu-2.3-scenarios.test.tsx`, `to-do.txt`
- **Tests added:** 51 (suite `src/tests/integration/hu-2.3-scenarios.test.tsx`)

## Deviations & Decisions
- **Added:** Archivos de prueba CSV para escenarios manuales (`test-scenario-1/2/3`) no previstos en el plan original.
- **Changed:** Ajuste de UX post-importación para ocultar el indicador ambiguo de `0 filas válidas` en estado final y reemplazarlo por conteo explícito de filas omitidas.
- **Skipped:** Ninguna tarea técnica del plan fue omitida.
- **Key Decisions:** Mantener detección de duplicados SKU en servidor (confirmación), no en preview client-side, para preservar idempotencia real contra estado actual de DB.
- **Escalated ADRs:** None
- **Lesson:** En importaciones masivas, separar claramente métricas de preview vs métricas post-confirmación evita confusión operativa durante pruebas reales.
