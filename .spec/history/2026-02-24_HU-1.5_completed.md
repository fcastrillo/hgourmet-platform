# Objective: HU-1.5 — Categorías con imagen administrable y visual homologado

## Context

- **Feature:** FEAT-1 — Catálogo Digital de Productos
- **Story:** Como administradora de HGourmet, quiero cargar y mantener una imagen por categoría desde el panel admin, para poder mostrar categorías consistentes y atractivas en homepage y catálogo sin depender de cambios en código.
- **Spec Level:** Lite
- **TDD Mode:** flexible
- **Estimated Duration:** 5h 30m

## Acceptance Criteria (BDD)

### Scenario 1: Admin sube imagen y se refleja en storefront

- **Dado que:** Soy una administradora autenticada y existe una categoría activa sin imagen
- **Cuando:** Subo una imagen válida en `CategoryFormModal` y guardo la categoría
- **Entonces:** Se actualiza `image_url` en la categoría y la imagen se muestra tanto en `CategoryShowcase` como en `CategoryCard`

### Scenario 2: Categoría sin imagen usa fallback homogéneo

- **Dado que:** Existe una categoría activa con `image_url` vacío o nulo
- **Cuando:** Un cliente visita homepage o catálogo
- **Entonces:** Ambas vistas renderizan el mismo fallback visual (icono + estilo base) sin diferencias de comportamiento

### Scenario 3: Error de carga o URL rota no rompe UI (Error/Excepción)

- **Dado que:** Una categoría tiene `image_url` inválido o la imagen no se puede cargar
- **Cuando:** El cliente visualiza la categoría en homepage o catálogo
- **Entonces:** El componente cae a fallback de forma segura, sin errores visibles ni quiebres de maquetación

## Implementation Plan

### Task 1: Validar precondiciones de datos e infraestructura de imágenes ✅

- **Type:** [DB]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `supabase/migrations/005_enabler2_schema_evolution.sql` (verificado), `docs/SETUP.md` (verificado)
- **Commit:** n/a (solo verificación, sin cambios de código)

### Task 2: Extender Server Actions de categorías para soportar `image_url` ✅

- **Type:** [SA]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/types/database.ts`, `src/app/(admin)/admin/categorias/actions.ts`
- **Commit:** `99aafb1`

### Task 3: Actualizar `CategoryFormModal` con upload de imagen y validaciones ✅

- **Type:** [CC]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/admin/CategoryFormModal.tsx`
- **Commit:** `b4c9d4d`

### Task 4: Homologar render visual de categorías en storefront con fallback consistente ✅

- **Type:** [SC] + [CC] (CategoryImage)
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/storefront/CategoryCard.tsx`, `src/components/storefront/CategoryShowcase.tsx`
- **Files created:** `src/components/storefront/CategoryImage.tsx`
- **Commit:** `62eaa7d`

### Task 5: Agregar cobertura de pruebas para escenarios HU-1.5 ✅

- **Type:** [TEST]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files created:** `src/tests/integration/hu-1.5-scenarios.test.tsx`
- **Files modified:** fixtures en 7 archivos de tests existentes (`image_url: null`)
- **Commit:** `ded30d6`

### Task 6: Verificación integral y hardening final ✅

- **Type:** [TEST]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Result:** 373/373 tests passed · TypeScript 0 errores
- **Commit:** `ded30d6`

## Database Changes

No aplica para HU-1.5. La columna `categories.image_url` ya fue incorporada por ENABLER-2.

## Infrastructure Changes

- **New environment variables:** None
- **New external services:** None
- **New storage/buckets:** None (reusar `category-images` ya definido)
- **New auth configuration:** None
- **SETUP.md update required:** No (verificar consistencia solamente)

## Manual Testing Checklist

- [x] Ingresar a `/admin/categorias`, crear categoría con imagen y confirmar preview + guardado exitoso.
- [x] Editar categoría existente y reemplazar imagen; validar persistencia tras recargar.
- [x] Forzar categoría sin imagen y validar fallback visual consistente en homepage y catálogo.
- [x] Simular URL de imagen inválida y confirmar fallback sin errores de UI.
- [x] Verificar que usuario no autenticado no puede acceder a carga/edición de imágenes en admin.

## Definition of Done

- [x] All BDD criteria have passing tests
- [x] No TypeScript errors
- [x] RLS policies tested (if applicable)
- [x] CHANGELOG entry drafted
- [x] All changes committed with `feat(HU-1.5):` convention
- [x] Tag `HU-1.5` created

## Completion

- **Date:** 2026-02-24
- **Estimated Duration:** 5h 30m
- **Actual Duration:** 23m 05s (from first `feat(HU-1.5)` to last `feat(HU-1.5)/fix(HU-1.5)` commit)
- **Variance:** ~14.3x faster than estimated (AI-assisted execution and focused scope)
- **Files modified:** `src/types/database.ts`, `src/app/(admin)/admin/categorias/actions.ts`, `src/components/admin/CategoryFormModal.tsx`, `src/components/storefront/CategoryCard.tsx`, `src/components/storefront/CategoryImage.tsx`, `src/components/storefront/CategoryShowcase.tsx`, `src/app/(admin)/admin/productos/actions.ts`, `src/app/(admin)/admin/productos/nuevo/page.tsx`, `src/app/(admin)/admin/productos/[id]/editar/page.tsx`, `src/tests/integration/hu-1.5-scenarios.test.tsx`, `src/tests/integration/hu-2.4-scenarios.test.tsx`, `src/tests/integration/categorias.test.tsx`, `src/tests/integration/CategoryFilter.test.tsx`, `src/tests/integration/hu-1.1-scenarios.test.tsx`, `src/tests/integration/hu-1.3-scenarios.test.tsx`, `src/tests/integration/hu-2.2-scenarios.test.tsx`, `src/tests/integration/categoria-detail.test.tsx`, `src/tests/integration/storefront-layout.test.tsx`, `public/images/categories/*`
- **Tests added:** 16 (`hu-1.5-scenarios.test.tsx`)

## Deviations & Decisions

- **Added:** Corrección post-validación de remoción de imagen (persistencia en edición) y fallback estático curado por slug (`public/images/categories`) para aproximar la referencia visual de Lovable.
- **Changed:** El fallback original (icono únicamente) evolucionó a estrategia de 3 niveles: `image_url` real → imagen estática curada → emoji de último recurso.
- **Skipped:** None.
- **Key Decisions:** Se priorizó compatibilidad visual con el prototipo manteniendo override admin-first (si existe imagen cargada por admin, siempre gana sobre el fallback estático).
- **Escalated ADRs:** None (tactical deviations only).
- **Lesson:** Para assets visuales curados, conviene definir fallback de diseño desde el inicio para evitar retrabajo posterior de UX.
