# Objective: HU-1.3 — Búsqueda y filtrado de productos

## Context

- **Feature:** FEAT-1 — Catálogo Digital de Productos
- **Story:** Como cliente de HGourmet, quiero buscar productos por nombre o descripción y filtrar por categoría y disponibilidad, para poder encontrar rápidamente un producto específico sin navegar manualmente por todas las categorías
- **Spec Level:** Standard
- **Git Strategy:** trunk (commits directamente a `main`)
- **Estimate:** M (~1–2 días)
- **tdd_mode:** flexible (IMPLEMENT → TEST → REFACTOR)

> **Nota de reconciliación:** El flujo `start-objective` → `apply` se ejecutó fuera de secuencia
> (análisis en Plan mode, implementación directa sin poblar este archivo previamente).
> Este documento se genera retroactivamente para restaurar la trazabilidad SpecSeed.

## Acceptance Criteria (BDD)

### Scenario 1: Búsqueda por nombre exitosa

- **Dado que:** Existen 3 productos visibles que contienen "chocolate" en su nombre
- **Cuando:** El cliente escribe "chocolate" en la barra de búsqueda
- **Entonces:** Se muestran los 3 productos que coinciden, en formato de tarjeta con imagen, nombre, precio y disponibilidad, en menos de 500ms

### Scenario 2: Búsqueda combinada con filtro de categoría

- **Dado que:** Existen 5 productos con "molde" en su nombre, 3 en categoría "Moldes" y 2 en "Accesorios"
- **Cuando:** El cliente escribe "molde" y selecciona el filtro de categoría "Moldes"
- **Entonces:** Se muestran únicamente los 3 productos de la categoría "Moldes" que coinciden con el término

### Scenario 3: Búsqueda con debounce

- **Dado que:** El cliente está en la página de catálogo
- **Cuando:** El cliente escribe "cho" rápidamente seguido de "colate" (formando "chocolate")
- **Entonces:** La búsqueda se ejecuta una sola vez después de 300ms de inactividad, no en cada tecla presionada

### Scenario 4: Sin resultados encontrados (Error/Excepción)

- **Dado que:** No existen productos con el término "unicornio" en nombre ni descripción
- **Cuando:** El cliente escribe "unicornio" en la barra de búsqueda
- **Entonces:** Se muestra un mensaje "No encontramos productos para 'unicornio'. Intenta con otro término o explora nuestras categorías" con enlaces a las categorías activas

### Scenario 5: Búsqueda excluye productos ocultos

- **Dado que:** Existe un producto "Chocolate Interno" con `is_visible = false` y un producto "Chocolate Belga" con `is_visible = true`
- **Cuando:** El cliente busca "chocolate"
- **Entonces:** Solo aparece "Chocolate Belga" en los resultados; "Chocolate Interno" nunca se muestra

## Architecture Decisions

- **ilike vs Full-Text Search:** Se optó por `ilike` con `or()` de Supabase para búsqueda parcial en `name` y `description`. Suficiente para el volumen MVP (~300–1000 productos), sin requerir migraciones adicionales (índices GIN, `to_tsvector`).
- **Client-side search:** Primera feature que usa el browser Supabase client (`src/lib/supabase/client.ts`). Las queries se ejecutan desde Client Components para soportar el debounce de 300ms en tiempo real.
- **Orquestador pattern:** `SearchableProductCatalog` es un Client Component que recibe categorías del server (SSR) y solo activa fetch client-side cuando hay búsqueda o filtro activo.

## Implementation Plan

### Task 1: Search query helper (~15 min) ✅

- **Type:** Helper / lib
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/lib/supabase/queries/search.ts` (new)

### Task 2: useDebounce custom hook (~10 min) ✅

- **Type:** `[CC]` hook
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/lib/hooks/useDebounce.ts` (new)

### Task 3: SearchBar component (~20 min) ✅

- **Type:** `[CC]` Client Component
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/components/storefront/SearchBar.tsx` (new)

### Task 4: CategoryFilter component (~15 min) ✅

- **Type:** `[CC]` Client Component
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/components/storefront/CategoryFilter.tsx` (new)

### Task 5: SearchableProductCatalog orchestrator (~30 min) ✅

- **Type:** `[CC]` Client Component
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/components/storefront/SearchableProductCatalog.tsx` (new)

### Task 6: Integrar en página /categorias (~15 min) ✅

- **Type:** `[SC]` modificación
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files:** `src/app/(storefront)/categorias/page.tsx` (modified)

### Task 7: Tests de integración HU-1.3 (~30 min) ✅

- **Type:** `[TEST]`
- **Cycle:** TEST ✅ → REFACTOR ✅
- **Files:**
  - `src/tests/integration/SearchBar.test.tsx` (new — 5 tests)
  - `src/tests/integration/CategoryFilter.test.tsx` (new — 6 tests)
  - `src/tests/integration/hu-1.3-scenarios.test.tsx` (new — 8 tests)
- **Resultado:** 83/83 passing (13 suites), 0 regresiones

### Task 8: Validación end-to-end ✅

- **Type:** Manual
- **Cycle:** IMPLEMENT ✅ → REFACTOR ✅
- **Files:** N/A

## Manual Testing Checklist

- [x] Escribir "chocolate" en la barra de búsqueda → aparecen productos coincidentes
- [x] Seleccionar una categoría → solo se muestran productos de esa categoría
- [x] Combinar texto + categoría → resultados cruzados correctos
- [x] Escribir rápido → solo 1 request después de 300ms de inactividad
- [x] Buscar término inexistente → mensaje "No encontramos productos..." con enlaces
- [x] Verificar que productos con `is_visible=false` no aparecen en ningún resultado
- [x] Probar en dispositivo móvil → teclado virtual no rompe la interfaz
- [x] Limpiar búsqueda → vuelve al grid de categorías original

## Definition of Done

- [x] All BDD criteria have passing tests (Scenarios 1–5)
- [x] No TypeScript errors (`npx tsc --noEmit`)
- [x] 19 nuevos tests, 83/83 total passing (13 suites)
- [x] Debounce de 300ms implementado y verificado con fake timers
- [x] Validación manual en browser (desktop + mobile)
- [x] CHANGELOG entry drafted
- [x] All changes committed with `feat(HU-1.3):` convention
- [x] Tag `HU-1.3` created

## Completion

- **Date:** 2026-02-22
- **Estimated Duration:** M (~1–2 días)
- **Actual Duration:** ~30 min (implementación en sesión única con AI assistance, sin timestamps de git por reconciliación de flujo)
- **Variance:** Estimado M (~1-2 días), real ~30 min — ~50-90x más rápido con asistencia AI
- **Files modified:** 8 creados, 2 modificados (+1 devDependency)
- **Tests added:** 19 nuevos (3 test suites: SearchBar, CategoryFilter, hu-1.3-scenarios)

## Deviations & Decisions

- **Added:** `@testing-library/user-event` como devDependency — necesario para simular typing con debounce en tests; no contemplado en plan original
- **Changed:** Flujo SpecSeed ejecutado fuera de secuencia (Plan mode → implementación directa → reconciliación retroactiva). El código y tests resultantes son idénticos a los que habría producido el flujo normal.
- **Skipped:** Ninguna
- **Key Decisions:**
  1. Primera feature que usa el browser Supabase client (`src/lib/supabase/client.ts`) para fetch client-side interactivo — ver ADR-007
  2. Patrón orquestador: Server Component pasa datos SSR a Client Component que condicionalmente activa fetch client-side — ver ADR-007
  3. `ilike` sobre `to_tsvector` para búsqueda textual — suficiente para volumen MVP, revisable en futuras iteraciones
- **Escalated ADRs:** ADR-007 (Client-Side Data Fetching for Interactive Features)
- **Lesson:** Al usar Cursor Plan mode para `@start-objective`, recordar cambiar a Agent mode antes de generar `current_objective.md` para mantener la secuencia SpecSeed intacta.
