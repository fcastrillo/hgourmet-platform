# Objective: HU-2.2 — CRUD de productos desde el panel

## Context

- **Feature:** FEAT-2 — Panel de Administración
- **Story:** Como administradora de HGourmet, quiero crear, ver, editar y ocultar productos desde el panel de administración, para poder mantener el catálogo actualizado con información precisa de precios, disponibilidad e imágenes
- **Spec Level:** Standard
- **tdd_mode:** flexible (IMPLEMENT → TEST → REFACTOR)
- **git_strategy:** trunk (commits directos a `main`)

## Acceptance Criteria (BDD)

### Escenario 1: Crear producto exitosamente

> **Dado que** soy una administradora autenticada en el panel,
> **Cuando** completo el formulario de nuevo producto con datos válidos (nombre, precio, categoría, imagen) y presiono "Guardar",
> **Entonces** el producto se crea en la base de datos, la imagen se sube a Supabase Storage, y el producto aparece en la lista del panel y en el catálogo público.

### Escenario 2: Editar producto

> **Dado que** soy una administradora viendo la lista de productos,
> **Cuando** hago clic en "Editar" de un producto existente, modifico el precio y presiono "Guardar",
> **Entonces** el precio se actualiza en la base de datos y el cambio se refleja inmediatamente en la lista del panel.

### Escenario 3: Ocultar producto (edge case)

> **Dado que** soy una administradora y quiero retirar un producto del catálogo sin eliminarlo,
> **Cuando** desactivo el toggle "Visible" de un producto,
> **Entonces** el producto deja de mostrarse en el storefront público pero sigue visible en la lista del panel con un indicador de "Oculto".

### Escenario 4: Validación de datos (error)

> **Dado que** intento crear un producto con precio ≤ 0 o sin nombre,
> **Cuando** envío el formulario,
> **Entonces** el sistema muestra mensajes de validación específicos y no crea el registro.

## Implementation Plan

### Task 1: Admin product query helpers ✅
### Task 2: Product server actions ✅
### Task 3: DeleteProductDialog component ✅
### Task 4: ProductTable component ✅
### Task 5: ProductForm component ✅
### Task 6: Admin product pages ✅
### Task 7: Integration tests — BDD scenarios ✅

## Completion

- **Date:** 2026-02-22
- **Estimated Duration:** ~3–4 días (backlog estimate)
- **Actual Duration:** ~2.5 horas (14:31 → 16:56, from first to last feat(HU-2.2) commit)
- **Variance:** Estimated M (~3-4 days), actual ~2.5h — ~12x faster with AI assistance
- **Files modified:**
  - `src/lib/supabase/queries/admin-products.ts` (created)
  - `src/app/(admin)/admin/productos/actions.ts` (created)
  - `src/app/(admin)/admin/productos/page.tsx` (created)
  - `src/app/(admin)/admin/productos/nuevo/page.tsx` (created)
  - `src/app/(admin)/admin/productos/[id]/editar/page.tsx` (created)
  - `src/components/admin/ProductTable.tsx` (created)
  - `src/components/admin/ProductForm.tsx` (created)
  - `src/components/admin/DeleteProductDialog.tsx` (created)
  - `src/tests/integration/hu-2.2-scenarios.test.tsx` (created)
  - `current_objective.md` (updated)
- **Tests added:** 29 (total: 164)

## Deviations & Decisions

- **Added:** `noValidate` attribute on `<form>` to prevent HTML5 native validation from blocking custom validation (price `min="0.01"` blocked onSubmit for value "0")
- **Changed:** ImageUpload was planned as a standalone `[CC]` component but was merged directly into ProductForm — the upload logic is tightly coupled to the FormData flow and a separate component added unnecessary indirection
- **Skipped:** AdminSidebar update — it already had active `<Link>` components pointing to `/admin/productos`
- **Key Decisions:**
  - Tailwind 4 `peer-checked:` selectors don't generate CSS classes for toggle switches — replaced with React state-driven conditional classes (escalated to ADR-010)
  - Image upload via server action FormData (not client-side Storage SDK) to avoid orphaned files
  - `noValidate` on forms with custom validation to avoid HTML5 native validation conflicts
- **Escalated ADRs:** ADR-010 — React State-Driven Toggle Styling in Tailwind 4
- **Lesson:** In Tailwind 4, always use React state for dynamic styling of interactive elements (toggles, switches) instead of CSS-only `peer-checked` selectors. The CSS-only approach is unreliable with Tailwind 4's JIT compilation.
