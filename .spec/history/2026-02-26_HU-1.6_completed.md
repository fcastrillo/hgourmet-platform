# Objective: HU-1.6 — Filtros avanzados de precio y toggle de disponibilidad con feedback completo

## Context

- **Feature:** FEAT-1 — Catálogo Digital de Productos
- **Story:** Como cliente de HGourmet navegando el catálogo, quiero filtrar por precio mínimo o máximo y entender claramente el estado del filtro de disponibilidad, para poder encontrar productos relevantes con menor fricción y mayor confianza en los controles de filtrado.
- **Spec Level:** Lite
- **TDD Mode:** flexible
- **Estimated Duration:** 5h 30m

## Acceptance Criteria (BDD)

### Scenario 1: Cliente filtra por precio mínimo (Desde)

- **Dado que:** Estoy en `/categorias` con productos de diferentes rangos de precio
- **Cuando:** Selecciono el modo `Desde` y ajusto el valor a `$750`
- **Entonces:** Solo se muestran productos con precio mayor o igual a `750`

### Scenario 2: Cliente filtra por precio máximo (Hasta)

- **Dado que:** Estoy en `/categorias` con productos de diferentes rangos de precio
- **Cuando:** Selecciono el modo `Hasta` y ajusto el valor a `$750`
- **Entonces:** Solo se muestran productos con precio menor o igual a `750`

### Scenario 3: Toggle de disponibilidad comunica estado y filtra resultados

- **Dado que:** El switch `Solo en stock` está apagado
- **Cuando:** Lo activo
- **Entonces:** El thumb se desplaza a la derecha, el control cambia a estado visual activo y el listado mantiene solo productos disponibles

### Scenario 4: Persistencia de filtros en URL y recarga

- **Dado que:** Tengo activos `mode=min`, `price=750` y `inStock=1`
- **Cuando:** Recargo la página o comparto la URL y se vuelve a abrir
- **Entonces:** El catálogo restaura el mismo estado de filtros y resultados equivalentes

### Scenario 5: Error de query params inválidos (Error/Excepción)

- **Dado que:** La URL contiene parámetros inválidos de filtro (ej. `price=abc` o `mode=foo`)
- **Cuando:** Entro a `/categorias` con esos parámetros
- **Entonces:** El catálogo aplica valores por defecto seguros, evita errores visibles y mantiene interacción funcional

## Implementation Plan

### Task 1: Definir contrato de filtros y parser robusto de query params (~45 min) ✅

- **Type:** [CC] + [SC]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/storefront/SearchableProductCatalog.tsx`, `src/app/(storefront)/categorias/page.tsx`
- **Verification:** `npm run test:run -- src/tests/integration/hu-1.6-scenarios.test.tsx` ✅
- **Commit:** Pending (not requested in this session)

### Task 2: Implementar modo de precio `Desde/Hasta` en UI y wiring con `searchProducts` (~55 min) ✅

- **Type:** [CC]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/storefront/SearchableProductCatalog.tsx`
- **Verification:** `npm run test:run -- src/tests/integration/hu-1.6-scenarios.test.tsx` ✅
- **Commit:** Pending (not requested in this session)

### Task 3: Corregir feedback visual completo del toggle `Solo en stock` (~35 min) ✅

- **Type:** [CC]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/storefront/SearchableProductCatalog.tsx`
- **Verification:** `npm run test:run -- src/tests/integration/hu-1.6-scenarios.test.tsx` ✅
- **Commit:** Pending (not requested in this session)

### Task 4: Persistir filtros en URL y restaurar estado en carga inicial (~55 min) ✅

- **Type:** [CC] + [SC]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/storefront/SearchableProductCatalog.tsx`, `src/app/(storefront)/categorias/page.tsx`
- **Verification:** `npm run test:run -- src/tests/integration/hu-1.6-scenarios.test.tsx` ✅
- **Commit:** Pending (not requested in this session)

### Task 5: Crear pruebas de integración para BDD HU-1.6 (~55 min) ✅

- **Type:** [TEST]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/tests/integration/hu-1.6-scenarios.test.tsx`, `src/tests/integration/hu-1.3-scenarios.test.tsx`
- **Verification:** `npm run test:run -- src/tests/integration/hu-1.6-scenarios.test.tsx src/tests/integration/hu-1.3-scenarios.test.tsx` ✅
- **Commit:** Pending (not requested in this session)

### Task 6: Regresión rápida de catálogo + validación técnica final (~45 min) ✅

- **Type:** [TEST]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/storefront/SearchableProductCatalog.tsx`, `src/app/(storefront)/categorias/page.tsx`, `src/tests/integration/hu-1.6-scenarios.test.tsx`, `src/tests/integration/hu-1.3-scenarios.test.tsx`
- **Verification:** `npm run test:run -- src/tests/integration/hu-1.6-scenarios.test.tsx src/tests/integration/hu-1.3-scenarios.test.tsx` ✅, `npm run lint` ⚠️ (interactive Next.js ESLint bootstrap prompt in this repo)
- **Commit:** Pending (not requested in this session)

## Database Changes

No aplica. HU-1.6 reutiliza columnas existentes (`products.price`, `products.is_available`) sin migraciones SQL ni cambios de RLS.

## Infrastructure Changes

- **New environment variables:** None
- **New external services:** None
- **New storage/buckets:** None
- **New auth configuration:** None
- **SETUP.md update required:** No

## Manual Testing Checklist

- [x] Abrir `/categorias`, seleccionar modo `Desde`, fijar `$750` y confirmar que resultados cumplen `>= 750`.
- [x] Cambiar a modo `Hasta`, mantener `$750` y confirmar que resultados cumplen `<= 750`.
- [x] Activar/desactivar `Solo en stock` y validar desplazamiento del thumb + consistencia de resultados.
- [x] Combinar categoría + búsqueda + precio + disponibilidad y confirmar que no se resetean filtros inesperadamente.
- [x] Recargar con filtros activos y validar restauración de estado desde URL.
- [x] Probar URL con parámetros inválidos (`price=abc`, `mode=foo`) y confirmar fallback seguro sin errores visuales.

## Definition of Done

- [x] All BDD criteria have passing tests
- [ ] No TypeScript errors
- [x] RLS policies tested (if applicable)
- [ ] CHANGELOG entry drafted
- [ ] All changes committed with `feat(HU-1.6):` convention
- [ ] Tag `HU-1.6` created

## Completion

- **Date:** 2026-02-26
- **Estimated Duration:** 5h 30m
- **Actual Duration:** ~17s (from first `feat(HU-1.6)` commit to `docs(HU-1.6): close objective`)
- **Variance:** ~1165x faster than estimated (implementation and cierre concentrados en una sola sesión con asistencia AI)
- **Files modified:** `src/components/storefront/SearchableProductCatalog.tsx`, `src/app/(storefront)/categorias/page.tsx`, `src/tests/integration/hu-1.6-scenarios.test.tsx`, `src/tests/integration/hu-1.3-scenarios.test.tsx`, `docs/BACKLOG.md`, `docs/CHANGELOG.md`, `.spec/work/FEAT-1/HU-1.6/README.md`, `.spec/work/FEAT-1/README.md`, `current_objective.md`
- **Tests added:** 5 (`hu-1.6-scenarios.test.tsx`)

## Deviations & Decisions

- **Added:** Ajuste UX posterior a feedback visual: quitar bordes en estados activos y hacer switch `Solo en stock` completamente clickeable.
- **Changed:** Implementación del modo `Desde` se resolvió invirtiendo visualmente el slider (`scaleX(-1)`) para resaltar lado derecho sin cambiar contrato de datos.
- **Skipped:** Ejecución de `npm run lint` no-interactiva (el comando actual inicia wizard interactivo de configuración ESLint en este repo).
- **Key Decisions:** Se usó `window.history.replaceState` para persistencia de filtros en URL sin navegación completa; se mantuvo parser robusto en Server Component para fallback seguro.
- **Escalated ADRs:** None
- **Lesson:** En filtros duales (`min/max`), separar explícitamente intención en UI (`Desde/Hasta`) evita ambigüedad funcional y reduce retrabajo de UX.
