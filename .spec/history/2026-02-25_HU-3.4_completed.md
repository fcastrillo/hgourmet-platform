# Objective: HU-3.4 — Formulario de contacto con envio real via WhatsApp

## Context
- **Feature:** FEAT-3 — Canal de Comunicacion y Conversion WhatsApp
- **Story:** Como cliente o visitante que necesita resolver dudas o confirmar un pedido, quiero enviar el formulario de `/contacto` y abrir WhatsApp con el mensaje ya prellenado, para poder contactar a HGourmet en un solo flujo sin copiar datos manualmente.
- **Spec Level:** Lite

## Acceptance Criteria (BDD)

### Escenario 1: Envio real con mensaje prellenado
> **Dado que** la persona completa nombre, telefono, mensaje y opcionalmente email en `/contacto`,
> **Cuando** hace clic en "Enviar por WhatsApp",
> **Entonces** el sistema debe abrir un deep link `wa.me` con el mensaje prellenado usando esos datos.

### Escenario 2: Validacion de requeridos
> **Dado que** falta al menos uno de los campos requeridos (`nombre`, `telefono`, `mensaje`),
> **Cuando** la persona intenta enviar el formulario,
> **Entonces** el sistema debe bloquear el envio y mostrar mensajes de validacion claros por campo.

### Escenario 3: Encoding seguro del mensaje
> **Dado que** el mensaje contiene saltos de linea, acentos o caracteres especiales,
> **Cuando** se genera la URL de WhatsApp,
> **Entonces** el contenido debe quedar correctamente codificado para abrirse sin corrupcion de texto.

### Escenario 4: Cancelacion o error al abrir WhatsApp (error)
> **Dado que** la accion de apertura de WhatsApp es cancelada o bloqueada por el navegador/dispositivo,
> **Cuando** finaliza el intento de envio,
> **Entonces** la interfaz no debe mostrar confirmacion de exito y debe informar un estado de error recuperable con opcion de reintento.

## Implementation Plan

### Task 1: Auditar estado actual del formulario de `/contacto` ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/app/(storefront)/contacto/page.tsx`, `src/components/storefront/ContactForm.tsx`
- **Commit:** 7a8e6ad

### Task 2: Implementar builder de mensaje y URL segura de WhatsApp ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/lib/whatsapp.ts` (nuevo), `src/components/storefront/ContactForm.tsx`
- **Commit:** 7a8e6ad

### Task 3: Aplicar validaciones de campos requeridos y mensajes por campo ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/storefront/ContactForm.tsx`
- **Commit:** 7a8e6ad

### Task 4: Manejar cancelacion/error de apertura de WhatsApp sin exito falso ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/storefront/ContactForm.tsx`
- **Commit:** 7a8e6ad

### Task 5: Actualizar/crear pruebas para criterios BDD de HU-3.4 ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/tests/integration/hu-3.4-scenarios.test.tsx` (nuevo, 20 tests), `src/tests/integration/hu-3.3-scenarios.test.tsx` (actualizado)
- **Commit:** 7a8e6ad
- **Result:** 398 tests passing, 27 test files

### Task 6: Validacion manual end-to-end en desktop y mobile ✅
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** N/A (validacion manual sobre `/contacto`)
- **Verification:** checklist manual HU-3.4 completado

## Database Changes (if applicable)
No aplica. Esta HU no requiere cambios de esquema, migraciones ni politicas RLS.

## Manual Testing Checklist
- [x] Abrir `/contacto`, completar nombre/telefono/mensaje validos y confirmar apertura de `wa.me` con texto prellenado.
- [x] Repetir envio con email vacio y confirmar que sigue funcionando (email opcional).
- [x] Intentar enviar con campos requeridos vacios y confirmar errores por campo sin abrir WhatsApp.
- [x] Probar mensaje con acentos, simbolos y saltos de linea para validar encoding correcto.
- [x] Simular cancelacion/bloqueo de apertura (popup bloqueado o cancelacion de app) y confirmar ausencia de exito falso.
- [x] Verificar que no hay regresion visual de layout/espaciado en `/contacto` (desktop y mobile).

## Definition of Done
- [x] All BDD criteria have passing tests
- [x] No TypeScript errors
- [x] RLS policies tested (if applicable)
- [x] CHANGELOG entry drafted
- [x] All changes committed with `feat(HU-3.4):` convention
- [x] Tag `HU-3.4` created

## Completion
- **Date:** 2026-02-25
- **Estimated Duration:** ~245 min (sum of planned tasks)
- **Actual Duration:** ~0 min by git timestamp window (single `feat(HU-3.4)` commit recorded)
- **Variance:** Implementacion compactada en un solo commit; esfuerzo real no inferible completamente solo por timestamps.
- **Files modified:** `.spec/work/FEAT-3/HU-3.4/README.md`, `.spec/work/FEAT-3/README.md`, `docs/BACKLOG.md`, `src/components/storefront/ContactForm.tsx`, `src/lib/whatsapp.ts`, `src/tests/integration/hu-3.3-scenarios.test.tsx`, `src/tests/integration/hu-3.4-scenarios.test.tsx`, `current_objective.md`
- **Tests added:** 20 (HU-3.4), con ajuste de regresion en HU-3.3

## Deviations & Decisions
- **Added:** `src/lib/whatsapp.ts` como helper dedicado para composicion/encoding de deep link.
- **Changed:** `ContactForm` evoluciono de placeholder de exito a apertura real de WhatsApp + fallback por bloqueo de popup.
- **Skipped:** Ninguno.
- **Key Decisions:** conservar estrategia ADR-002 (deep link `wa.me`) y evitar “success fake” mostrando estado honesto de apertura.
- **Escalated ADRs:** None (decision aligned with existing ADR-002).
- **Lesson:** Para formularios de salida a apps externas, modelar explícitamente estados de bloqueo/denegación evita falsos positivos de UX.
