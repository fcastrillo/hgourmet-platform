# Objective: HU-1.2 — Ficha de detalle de producto

## Context

- **Feature:** FEAT-1 — Catálogo Digital de Productos
- **Story:** Como cliente de HGourmet, quiero ver la ficha completa de un producto con su imagen, descripción, precio y disponibilidad, para poder tomar una decisión de compra informada antes de contactar por WhatsApp
- **Spec Level:** Lite
- **Git Strategy:** trunk (commits directamente a `main`)
- **Estimate:** S (~4–8 horas)
- **tdd_mode:** flexible (IMPLEMENT → TEST → REFACTOR)

## Acceptance Criteria (BDD)

### Scenario 1: Visualización completa de producto disponible

- **Dado que:** El producto "Chocolate Belga 1kg" existe con `is_visible = true`, `is_available = true`, precio $350.00, e imagen cargada
- **Cuando:** El cliente accede a `/productos/chocolate-belga-1kg`
- **Entonces:** Se muestra la ficha con imagen optimizada, nombre "Chocolate Belga 1kg", precio "$350.00 MXN", descripción completa, badge "Disponible", y un botón "Pide por WhatsApp"

### Scenario 2: Producto con metadatos SEO correctos

- **Dado que:** El producto "Harina de Almendra 500g" tiene nombre, descripción e imagen
- **Cuando:** Un motor de búsqueda o red social rastrea la URL `/productos/harina-de-almendra-500g`
- **Entonces:** La página contiene meta tags con `og:title`, `og:description`, `og:image` y `<title>` generados a partir de los datos del producto

### Scenario 3: Navegación con breadcrumb

- **Dado que:** El producto "Molde Silicona Rosas" pertenece a la categoría "Moldes"
- **Cuando:** El cliente visualiza la ficha del producto
- **Entonces:** Se muestra un breadcrumb "Inicio > Moldes > Molde Silicona Rosas" con enlaces activos a cada nivel

### Scenario 4: Producto no disponible

- **Dado que:** El producto "Sprinkles Arcoíris" tiene `is_available = false`
- **Cuando:** El cliente accede a la ficha del producto
- **Entonces:** Se muestra la ficha completa con un badge "Agotado" visible, y el botón de WhatsApp está deshabilitado o no se muestra

### Scenario 5: Producto no visible o inexistente (Error/Excepción)

- **Dado que:** El producto tiene `is_visible = false`, o el slug solicitado no existe
- **Cuando:** El cliente accede directamente a la URL del producto
- **Entonces:** Se muestra una página 404 con mensaje amigable y enlace para volver al catálogo

## Implementation Plan

### Task 1: Typed data-fetching helpers para productos (~30 min) ✅

- **Type:** `[SC]` / lib
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Commit:** `c275981`

### Task 2: Configurar remotePatterns para Supabase Storage (~15 min) ✅

- **Type:** Config
- **Cycle:** IMPLEMENT ✅ → REFACTOR ✅
- **Note:** Ya estaba configurado desde HU-1.1 — no requirió cambios ✅

### Task 3: Componente Breadcrumb `[SC]` (~20 min) ✅

- **Type:** `[SC]` Server Component
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Commit:** `c275981`

### Task 4: Componente WhatsAppCTA `[CC]` (~20 min) ✅

- **Type:** `[CC]` Client Component
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Commit:** `c275981`

### Task 5: Página de detalle `/productos/[slug]` con generateMetadata `[SC]` (~45 min) ✅

- **Type:** `[SC]` Server Component — crítico para SEO
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Commit:** `c275981`

### Task 6: Tests de integración para HU-1.2 (~45 min) ✅

- **Type:** `[TEST]`
- **Cycle:** TEST ✅ → REFACTOR ✅
- **Commit:** `c275981` | Tests: 64/64 passing (10 suites)

### Task 7: Validación end-to-end (~20 min) ✅

- **Type:** `[TEST]` manual + fix
- **Cycle:** TEST ✅ → REFACTOR ✅
- **Commit:** `4a97c17` (fix)
- **Resultado:** 2 bugs detectados y corregidos (ver Deviations)

## Database Changes

Ninguno — HU-1.2 reutiliza las tablas `products` y `categories` con sus columnas y RLS existentes.

## Manual Testing Checklist

- [x] Acceder a `/productos/[slug-real]` con producto disponible — ver imagen, nombre, precio, badge "Disponible"
- [x] Clic en botón WhatsApp — abre `wa.me/` con texto pre-compuesto con nombre del producto
- [x] Ver breadcrumb: "Inicio / [Categoría] / [Producto]" — cada enlace navega correctamente
- [x] Verificar en DevTools: `<title>`, `og:title`, `og:description` en `<head>`
- [x] Acceder a producto con `is_available = false` — badge "Agotado", botón deshabilitado
- [x] Acceder a `/productos/slug-que-no-existe` — página 404 amigable con enlace al catálogo

## Definition of Done

- [x] Todos los BDD criteria tienen tests pasando (Scenarios 1-5)
- [x] `npx tsc --noEmit` — cero errores TypeScript
- [x] `npm run build` — cero errores, cero warnings
- [x] `npx vitest run` — 100% passing (64/64)
- [x] RLS validada: query filtra `is_visible = true`
- [x] Entry en CHANGELOG.md redactada
- [x] Todos los cambios committed con prefijo `feat(HU-1.2):` / `fix(HU-1.2):`
- [x] Tag `HU-1.2` creado en git

## Completion

- **Date:** 2026-02-21
- **Estimated Duration:** S (~4–8 horas)
- **Actual Duration:** ~12 min (20:48 → apply, 20:59 → fix commit)
- **Variance:** Estimado S (~4–8h), real ~12 min — ~20-40x más rápido con asistencia AI
- **Files modified:** 10 creados, 3 modificados (+839 / -18 líneas)
- **Tests added:** 28 nuevos (3 test suites: hu-1.2-scenarios, Breadcrumb, WhatsAppCTA)

## Deviations & Decisions

- **Added:** Commit `fix(HU-1.2)` post-validación — corrige 2 bugs detectados en inspección manual
- **Changed:** Task 2 (remotePatterns) → ya resuelto desde HU-1.1, tomó 0 min en lugar de 15
- **Skipped:** Ninguna
- **Key Decisions:**
  1. `generateMetadata` devuelve solo `product.name` como `title` (sin `| HGourmet`) porque el `template` del root layout (`"%s | HGourmet"`) ya añade el sufijo automáticamente
  2. Color verde de WhatsApp (`#25D366`) implementado via `style` inline, no via clase Tailwind arbitraria — ver ADR-006
- **Escalated ADRs:** ADR-006 (Inline Styles for Non-Tailwind Brand Colors)
- **Lesson:** Tailwind 4 no genera en tiempo de build clases arbitrarias (`bg-[#hex]`) que no estén referenciadas en CSS estático. Usar siempre `style` inline o definir el color en el design system (`globals.css`) para colores de terceros (WhatsApp, social brands).
