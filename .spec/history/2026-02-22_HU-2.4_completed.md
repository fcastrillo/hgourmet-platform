# Objective: HU-2.4 — Gestión de categorías

## Context
- **Feature:** FEAT-2 — Panel de Administración
- **Story:** Como administradora de HGourmet, quiero crear, editar, reordenar y ocultar categorías de productos desde el panel, para poder organizar el catálogo según las necesidades del negocio sin intervención técnica
- **Spec Level:** Standard
- **Git Strategy:** trunk (commits directos a `main`)
- **TDD Mode:** flexible (`IMPLEMENT → TEST → REFACTOR`)

## Acceptance Criteria (BDD)

### Escenario 1: Crear categoría exitosamente

> **Dado que** soy una administradora autenticada,
> **Cuando** creo una nueva categoría con nombre "Especias" y presiono "Guardar",
> **Entonces** la categoría se crea con slug "especias", display_order asignado automáticamente, y aparece en la lista del panel y en la navegación del storefront.

### Escenario 2: Reordenar categorías

> **Dado que** soy una administradora y quiero reordenar las categorías,
> **Cuando** cambio el orden de "Moldes" de posición 4 a posición 2,
> **Entonces** las posiciones de las categorías intermedias se ajustan automáticamente y el orden se refleja en la navegación pública.

### Escenario 3: Eliminar categoría con productos asociados (error)

> **Dado que** intento eliminar la categoría "Chocolate" que tiene 15 productos asociados,
> **Cuando** confirmo la eliminación,
> **Entonces** el sistema bloquea la operación y muestra "No se puede eliminar: 15 productos asociados. Mueva o elimine los productos primero."

## Implementation Plan

### Task 1: Utility — Slugify helper ✅
- **Type:** [UTIL]
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/lib/slugify.ts`
- **Commit:** 241fbef

### Task 2: Admin queries — Fetch categories for admin panel ✅
- **Type:** [SC] Server-side queries
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/lib/supabase/queries/admin-categories.ts`
- **Commit:** 241fbef

### Task 3: Server Actions — Category CRUD + reorder ✅
- **Type:** [SA] Server Actions
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/app/(admin)/admin/categorias/actions.ts`
- **Commit:** 241fbef

### Task 4: Category list page ✅
- **Type:** [SC] Server Component (page)
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/app/(admin)/admin/categorias/page.tsx`
- **Commit:** 241fbef

### Task 5: CategoryTable component con reorder ✅
- **Type:** [CC] Client Component
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/admin/CategoryTable.tsx`
- **Commit:** 241fbef

### Task 6: CategoryFormModal component ✅
- **Type:** [CC] Client Component
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/admin/CategoryFormModal.tsx`
- **Commit:** 241fbef

### Task 7: Delete confirmation with FK protection ✅
- **Type:** [CC] Client Component
- **Cycle:** IMPLEMENT ✅ → TEST ✅ → REFACTOR ✅
- **Files modified:** `src/components/admin/DeleteCategoryDialog.tsx`
- **Commit:** 241fbef

### Task 8: Integration tests ✅
- **Type:** [TEST]
- **Cycle:** TEST ✅
- **Files modified:** `src/tests/integration/hu-2.4-scenarios.test.tsx`
- **Tests:** 22 passing, 0 failing
- **Commit:** 241fbef

### Task 9: Manual testing and polish ✅
- **Type:** [MANUAL]
- **Cycle:** VERIFY ✅
- **Files modified:** `src/app/(admin)/admin/page.tsx` (dashboard card updated)

## Completion
- **Date:** 2026-02-22
- **Estimated Duration:** ~1–2 días (del BACKLOG), ~4 horas (plan detallado)
- **Actual Duration:** ~1 hora (13:42 commit único con asistencia AI)
- **Variance:** Estimado ~4h, actual ~1h — ~4x más rápido con asistencia AI
- **Files modified:** 9 archivos (8 creados, 1 modificado)
  - `src/lib/slugify.ts` (new)
  - `src/lib/supabase/queries/admin-categories.ts` (new)
  - `src/app/(admin)/admin/categorias/actions.ts` (new)
  - `src/app/(admin)/admin/categorias/page.tsx` (new)
  - `src/components/admin/CategoryTable.tsx` (new)
  - `src/components/admin/CategoryFormModal.tsx` (new)
  - `src/components/admin/DeleteCategoryDialog.tsx` (new)
  - `src/tests/integration/hu-2.4-scenarios.test.tsx` (new)
  - `src/app/(admin)/admin/page.tsx` (modified)
- **Tests added:** 22

## Deviations & Decisions
- **Added:** Dashboard card polish (`src/app/(admin)/admin/page.tsx` — cambiar "Próximamente →" a "Gestionar →" para la tarjeta de Categorías). No estaba en el plan original pero es un polish lógico.
- **Changed:** None
- **Skipped:** None
- **Key Decisions:** Extensión de ADR-005 para mutaciones (insert/update): Supabase TS resuelve `.update().eq()` como `never` al igual que con queries encadenadas. Se usó `@ts-expect-error` con referencia explícita a ADR-005 para las server actions. Patrón táctico consistente con la decisión ya documentada.
- **Escalated ADRs:** None (extensión táctica de ADR-005 existente)
- **Lesson:** El patrón ADR-005 aplica igual para mutaciones (insert/update) que para queries. Considerar documentar esto explícitamente cuando se implemente HU-2.2 (CRUD de productos) para evitar re-descubrimiento.
