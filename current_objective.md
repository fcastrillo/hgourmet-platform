# Objective: HU-1.1 — Navegación por categorías de productos

## Context

- **Feature:** FEAT-1 — Catálogo Digital de Productos
- **Story:** Como cliente de HGourmet (repostero, estudiante o ama de casa), quiero navegar por las categorías de productos (Chocolate, Harinas, Sprinkles, Moldes, Materia Prima, Accesorios), para poder encontrar rápidamente los insumos que necesito sin recorrer todo el catálogo
- **Spec Level:** Standard
- **Git Strategy:** trunk (all commits to `main`)
- **Estimate:** M (~2–3 days)

## Acceptance Criteria (BDD)

### Scenario 1: Navegación exitosa por categoría

- **Dado que:** Existen 3 categorías activas ("Chocolate", "Harinas", "Moldes") con productos visibles
- **Cuando:** El cliente accede a la página de catálogo
- **Entonces:** Se muestran las 3 categorías ordenadas por `display_order`, cada una con su nombre y la cantidad de productos disponibles

### Scenario 2: Filtrado de productos al seleccionar categoría

- **Dado que:** La categoría "Chocolate" tiene 5 productos visibles y 2 ocultos
- **Cuando:** El cliente selecciona la categoría "Chocolate"
- **Entonces:** Se muestran únicamente los 5 productos visibles en formato de tarjeta con imagen, nombre, precio y disponibilidad

### Scenario 3: Producto agotado visible con indicador

- **Dado que:** El producto "Chocolate Belga 1kg" tiene `is_available = false` e `is_visible = true`
- **Cuando:** El cliente navega a la categoría que contiene ese producto
- **Entonces:** El producto se muestra con un badge visual "Agotado" y el botón de acción (WhatsApp) está deshabilitado o ausente

### Scenario 4: Categoría sin productos

- **Dado que:** La categoría "Sprinkles" está activa pero no tiene productos visibles
- **Cuando:** El cliente selecciona la categoría "Sprinkles"
- **Entonces:** Se muestra un mensaje amigable "No hay productos disponibles en esta categoría por el momento" en lugar de una página vacía

### Scenario 5: Categoría inactiva no visible (Error/Excepción)

- **Dado que:** La categoría "Temporada Navideña" tiene `is_active = false`
- **Cuando:** El cliente accede a la página de catálogo o intenta navegar directamente a `/categorias/temporada-navidena`
- **Entonces:** La categoría no aparece en el menú de navegación, y el acceso directo por URL retorna una página 404

## Implementation Plan

### Task 1: Project Scaffolding (~30 min) ✅

- **Type:** [CONFIG]
- **Cycle:** N/A ✅
- **Commit:** `8aa952b`
- **Files:**
  - `package.json` (generated by create-next-app)
  - `next.config.ts`
  - `tsconfig.json`
  - `src/app/layout.tsx` (root layout placeholder)
  - `src/app/page.tsx` (homepage placeholder)
  - `.env.local.example`
  - `.gitignore` (update with Next.js patterns)
- **Actions:**
  1. Initialize Next.js 15 with App Router, TypeScript, TailwindCSS 4, ESLint
  2. Verify `src/` directory structure matches TECH_SPEC.md project structure
  3. Create `.env.local.example` with `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` placeholders
- **Verification:** `npm run build` completes without errors

### Task 2: Supabase Client Setup (~30 min) ✅

- **Type:** [CONFIG]
- **Cycle:** N/A ✅
- **Commit:** `402bc30`
- **Files:**
  - `src/lib/supabase/server.ts` — server-side Supabase client
  - `src/lib/supabase/client.ts` — browser-side Supabase client
  - `src/types/database.ts` — TypeScript types for DB schema
  - `src/lib/constants.ts` — WhatsApp number, social links
- **Actions:**
  1. Install `@supabase/supabase-js` and `@supabase/ssr`
  2. Create server client using `createServerClient` with cookie handling
  3. Create browser client using `createBrowserClient`
  4. Define TypeScript types for `categories` and `products` tables matching TECH_SPEC.md
  5. Add constants file with WhatsApp number placeholder and social links
- **Verification:** TypeScript compiles without errors (`npx tsc --noEmit`)

### Task 3: Database Schema — Categories + Products (~45 min) ✅

- **Type:** [DB]
- **Cycle:** N/A ✅
- **Commit:** `c8fb518`
- **Files:**
  - `supabase/migrations/001_categories_and_products.sql`
  - `supabase/seed.sql`
- **Actions:**
  1. Create `categories` table: id (uuid PK), name, slug, description, display_order, is_active, created_at
  2. Create `products` table: id (uuid PK), category_id (FK), name, slug, description, price, image_url, sku, is_available, is_featured, is_seasonal, is_visible, created_at, updated_at
  3. Create indexes: products(category_id), products(is_visible, is_available), products(is_featured), products(is_seasonal)
  4. Create RLS policies:
     - categories: anon SELECT (all rows), authenticated FULL
     - products: anon SELECT (WHERE is_visible = true), authenticated FULL
  5. Create seed data: 6 categories + 15 products (including 2 hidden, 2 unavailable, 3 featured, 2 seasonal)
- **Verification:** Run migration against Supabase project; seed data loads successfully

### Task 4: Storefront Layout + Category Navigation (~45 min) ✅

- **Type:** [SC]
- **Cycle:** RED ✅ → GREEN ✅ → REFACTOR ✅
- **Commit:** `8f28edc`
- **Files:**
  - `src/app/(storefront)/layout.tsx` — storefront layout with header/footer
  - `src/components/storefront/Header.tsx` — header with logo + category nav
  - `src/components/storefront/Footer.tsx` — footer with links
  - `src/components/storefront/CategoryNav.tsx` — category navigation menu (fetches active categories)
- **Actions:**
  1. RED: Write test that storefront layout renders header with category navigation showing active categories
  2. GREEN: Implement storefront layout group with header (logo, category nav) and footer
  3. GREEN: CategoryNav fetches active categories from Supabase ordered by display_order
  4. REFACTOR: Extract common styles, ensure mobile-first responsive design (hamburger menu on mobile)
- **Verification:** `npm test` — layout renders with categories; visual check on mobile viewport

### Task 5: ProductCard Component (~30 min) ✅

- **Type:** [SC]
- **Cycle:** RED ✅ → GREEN ✅ → REFACTOR ✅
- **Commit:** `d702a57`
- **Files:**
  - `src/components/storefront/ProductCard.tsx` — reusable product card
  - `src/tests/integration/ProductCard.test.tsx`
- **Actions:**
  1. RED: Write test that ProductCard renders image, name, price (formatted as MXN), and availability badge
  2. RED: Write test that unavailable product shows "Agotado" badge with distinct visual style
  3. GREEN: Implement ProductCard with Next.js `<Image>`, formatted price, conditional availability badge
  4. REFACTOR: Responsive sizing (card adapts from 1-col mobile to 2/3/4-col grid)
- **Verification:** `npm test` — both tests pass; component renders correctly in isolation

### Task 6: Category Listing Page — `/categorias` (~45 min)

- **Type:** [SC]
- **Cycle:** RED → GREEN → REFACTOR
- **Files:**
  - `src/app/(storefront)/categorias/page.tsx` — category listing page
  - `src/tests/integration/categorias.test.tsx`
- **Actions:**
  1. RED: Write test that page shows all active categories with name and product count (BDD Scenario 1)
  2. RED: Write test that inactive categories are NOT rendered (BDD Scenario 5 — partial)
  3. GREEN: Implement Server Component that queries categories with product count subquery
  4. GREEN: Render category cards in responsive grid, ordered by display_order
  5. REFACTOR: Add category card hover effects, consistent spacing
- **Verification:** `npm test` — listing tests pass; `npm run dev` — visual verification at `/categorias`

### Task 7: Category Detail Page — `/categorias/[slug]` (~45 min)

- **Type:** [SC]
- **Cycle:** RED → GREEN → REFACTOR
- **Files:**
  - `src/app/(storefront)/categorias/[slug]/page.tsx` — category products page
  - `src/tests/integration/categoria-detail.test.tsx`
- **Actions:**
  1. RED: Write test that page shows only visible products for the selected category (BDD Scenario 2)
  2. RED: Write test that unavailable products display "Agotado" badge (BDD Scenario 3)
  3. RED: Write test that empty category shows friendly message (BDD Scenario 4)
  4. GREEN: Implement Server Component that fetches category by slug, then visible products
  5. GREEN: Render product grid using ProductCard component
  6. GREEN: Implement empty state with friendly message and link back to categories
  7. REFACTOR: Add category title, product count, responsive grid
- **Verification:** `npm test` — all 3 tests pass; visual verification at `/categorias/chocolate`

### Task 8: 404 Handling for Invalid Categories (~20 min)

- **Type:** [SC]
- **Cycle:** RED → GREEN → REFACTOR
- **Files:**
  - `src/app/(storefront)/categorias/[slug]/not-found.tsx` — custom 404 for invalid category
  - `src/tests/integration/categoria-not-found.test.tsx`
- **Actions:**
  1. RED: Write test that accessing `/categorias/nonexistent-slug` returns 404 page (BDD Scenario 5)
  2. RED: Write test that accessing an inactive category slug returns 404
  3. GREEN: Use Next.js `notFound()` function in page when category not found or inactive
  4. GREEN: Implement friendly not-found page with message and link to `/categorias`
  5. REFACTOR: Consistent styling with rest of storefront
- **Verification:** `npm test` — 404 tests pass; manual test navigating to invalid slug

### Task 9: Homepage Redirect + Polish (~20 min)

- **Type:** [SC]
- **Cycle:** RED → GREEN → REFACTOR
- **Files:**
  - `src/app/(storefront)/page.tsx` — homepage (temporary redirect or landing)
- **Actions:**
  1. RED: Write test that homepage renders and links to `/categorias`
  2. GREEN: Implement minimal homepage with hero section and CTA to browse categories
  3. REFACTOR: Ensure consistent design tokens (typography, colors per TECH_SPEC.md)
- **Verification:** `npm test`; visual check at `/`

### Task 10: End-to-End Validation (~30 min)

- **Type:** [TEST]
- **Cycle:** RED → GREEN → REFACTOR
- **Files:**
  - `src/tests/integration/hu-1.1-scenarios.test.tsx` — consolidated BDD scenario tests
- **Actions:**
  1. Verify all 5 BDD scenarios have corresponding passing tests
  2. Run full test suite and ensure zero failures
  3. Run `npm run build` to verify production build succeeds
  4. Run Lighthouse audit on `/categorias` for performance baseline
- **Verification:** `npm test && npm run build` — both pass with 0 errors

## Database Changes

```sql
-- Migration: 001_categories_and_products.sql

-- Categories table
CREATE TABLE categories (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  slug text NOT NULL UNIQUE,
  description text,
  display_order integer NOT NULL DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Products table
CREATE TABLE products (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  category_id uuid NOT NULL REFERENCES categories(id) ON DELETE RESTRICT,
  name text NOT NULL,
  slug text NOT NULL UNIQUE,
  description text,
  price numeric(10,2) NOT NULL CHECK (price > 0),
  image_url text,
  sku text UNIQUE,
  is_available boolean NOT NULL DEFAULT true,
  is_featured boolean NOT NULL DEFAULT false,
  is_seasonal boolean NOT NULL DEFAULT false,
  is_visible boolean NOT NULL DEFAULT true,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- Indexes
CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_visible_available ON products(is_visible, is_available);
CREATE INDEX idx_products_featured ON products(is_featured);
CREATE INDEX idx_products_seasonal ON products(is_seasonal);

-- RLS: Enable
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;

-- RLS: Categories
CREATE POLICY "categories_anon_select" ON categories
  FOR SELECT TO anon USING (true);

CREATE POLICY "categories_auth_all" ON categories
  FOR ALL TO authenticated USING (true) WITH CHECK (true);

-- RLS: Products
CREATE POLICY "products_anon_select" ON products
  FOR SELECT TO anon USING (is_visible = true);

CREATE POLICY "products_auth_all" ON products
  FOR ALL TO authenticated USING (true) WITH CHECK (true);
```

## Manual Testing Checklist

- [ ] Navigate to `/categorias` — all active categories display with product counts
- [ ] Click a category — only visible products appear in grid
- [ ] Verify an "Agotado" badge appears on unavailable products
- [ ] Navigate to a category with no visible products — friendly empty message displays
- [ ] Enter an invalid category slug in URL — 404 page displays with link back
- [ ] Test on mobile viewport (375px) — layout is responsive, cards stack properly
- [ ] Test on desktop viewport (1280px) — grid shows 3-4 columns
- [ ] Verify inactive categories do NOT appear anywhere in the navigation

## Definition of Done

- [ ] All 5 BDD criteria have passing tests
- [ ] No TypeScript errors (`npx tsc --noEmit`)
- [ ] RLS policies tested (categories: anon reads all; products: anon reads only visible)
- [ ] CHANGELOG entry drafted
- [ ] All changes committed with `feat(HU-1.1):` convention
- [ ] Tag `HU-1.1` created

## Deviations

> - **Task 4:** Se creó `MobileNav.tsx` (CC) adicional no previsto en el plan original — necesario para responsive hamburger menu.
> - **Task 4:** Se requirió cleanup explícito en `setup.ts` de Vitest para React 19 + testing-library v16.
> - **Task 5:** `ProductCard` muestra badge "Agotado" tanto como overlay en imagen como en texto inferior — decisión de UX para máxima visibilidad.
